# This file was auto-generated by the Firebase CLI
# https://github.com/firebase/firebase-tools

name: Deploy NEK to Firebase Hosting on merge
on:
  push:
    branches:
      - main
    paths:
      - packages/new-england-keeshonds/**
      - package.json
  workflow_dispatch:

env:
  NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}
jobs:
  build_and_preview:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout [main]
        uses: actions/checkout@ac593985615ec2ede58e132d2e21d2b1cbd6127c # pin@v3
        with:
          fetch-depth: 0
      - name: Derive appropriate SHAs for base and head for `nx affected` commands
        uses: nrwl/nx-set-shas@177b48373c6dc583ce0d9257ffb484bdd232fedf # pin@v3
      - name: Setup PNPM
        uses: pnpm/action-setup@c3b53f6a16e57305370b4ae5a540c2077a1d50dd # pin@v2
        with:
          version: latest
      - name: Setup node
        uses: actions/setup-node@64ed1c7eab4cce3362f8c340dee64e5eaeef8f7c # pin@v3
        with:
          node-version: '16'
          cache: 'pnpm'
      - name: Install dependencies
        run: pnpm install
      # NEW ENGLAND KEESHONDS
      - name: Check if deploy is needed
        id: nek_deploy_needed
        run: echo "DEPLOY=$(./scripts/isaffected.sh new-england-keeshonds-frontend)" >> $GITHUB_OUTPUT
      - name: Build New England Keeshonds
        run: |
          pnpm exec nx run new-england-keeshonds-frontend:build:production
          mv dist/packages/new-england-keeshonds/frontend packages/new-england-keeshonds/firebase/public
        env:
          VITE_FIREBASE_CONFIG: ${{ secrets.NEK_FIREBASE_CONFIG }}
          VITE_RECAPTCHA_V3_SITE_KEY: ${{ secrets.NEK_RECAPTCHA_V3_SITE_KEY }}
        if: steps.nek_deploy_needed.outputs.DEPLOY == 1
      - name: Deploy New England Keeshonds
        uses: FirebaseExtended/action-hosting-deploy@4d0d0023f1d92b9b7d16dda64b3d7abd2c98974b # pin@v0
        if: steps.nek_deploy_needed.outputs.DEPLOY == 1
        with:
          repoToken: '${{ secrets.GITHUB_TOKEN }}'
          firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT_NEW_ENGLAND_KEESHONDS }}'
          projectId: new-england-keeshonds
          channelId: live
          entryPoint: packages/new-england-keeshonds/firebase
        env:
          NX_FIREBASE_ADMIN_SDK: ${{ secrets.NEK_FIREBASE_ADMIN_SDK }}
