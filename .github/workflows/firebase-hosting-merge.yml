# This file was auto-generated by the Firebase CLI
# https://github.com/firebase/firebase-tools

name: Deploy to Firebase Hosting on merge
on:
  release:
    types: [released]
env:
  NX_NEK_FIREBASE_CONFIG: ${{ secrets.NEK_FIREBASE_CONFIG }}
  NX_NEK_FIREBASE_ADMIN_SDK: ${{ secrets.NEK_FIREBASE_ADMIN_SDK }}
  NX_NEK_RECAPTCHA_V3_SITE_KEY: ${{ secrets.NEK_RECAPTCHA_V3_SITE_KEY }}
  NX_NEK_FIREBASE_APPCHECK_DEBUG_TOKEN: ${{ secrets.NEK_FIREBASE_APPCHECK_DEBUG_TOKEN }}
  NX_PORTFOLIO_FIREBASE_CONFIG: ${{ secrets.PORTFOLIO_FIREBASE_CONFIG }}
  NX_PORTFOLIO_FIREBASE_ADMIN_SDK: ${{ secrets.PORTFOLIO_FIREBASE_ADMIN_SDK }}
  NX_PORTFOLIO_RECAPTCHA_V3_SITE_KEY: ${{ secrets.PORTFOLIO_RECAPTCHA_V3_SITE_KEY }}
  NX_PORTFOLIO_FIREBASE_APPCHECK_DEBUG_TOKEN: ${{ secrets.PORTFOLIO_FIREBASE_APPCHECK_DEBUG_TOKEN }}
jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout [main]
        uses: actions/checkout@7884fcad6b5d53d10323aee724dc68d8b9096a2e # ratchet:actions/checkout@v2
        with:
          fetch-depth: 0
      - name: Derive appropriate SHAs for base and head for `nx affected` commands
        uses: nrwl/nx-set-shas@e698d52609f0f36b4f79fa52afdae222e3255da7 # ratchet:nrwl/nx-set-shas@v2
      - name: Setup PNPM
        uses: pnpm/action-setup@10693b3829bf86eb2572aef5f3571dcf5ca9287d # ratchet:pnpm/action-setup@v2.2.2
        with:
          version: 7.0.0
      - name: Setup node
        uses: actions/setup-node@1f8c6b94b26d0feae1e387ca63ccbdc44d27b561 # ratchet:actions/setup-node@v2
        with:
          node-version: '16'
      - name: Install dependencies
        run: pnpm install
      - name: Get release property
        id: tagname
        run: |
          tagname=$(echo "${{ github.event.release.tag_name }}" | sed -r 's/[[:space:]]-[[:space:]]v[0-9]+.[0-9]+.[0-9]+//g')
          echo "::set-output tagname=tagname::$tagname"
        # NEW ENGLAND KEESHONDS
      - name: Check if deploy is needed
        id: nek_deploy_needed
        run: echo "::set-output name=deploy::$(./scripts/isequal.sh \"New England Keeshonds\" \"${{ steps.tagname.outputs.tagname }})\""
      - name: Build New England Keeshonds
        run: pnpm exec nx run new-england-keeshonds:build:production && mv dist/apps/new-england-keeshonds apps/new-england-keeshonds/out
        if: steps.nek_deploy_needed.outputs.deploy == 1
      - name: Deploy New England Keeshonds
        uses: FirebaseExtended/action-hosting-deploy@276388dd6c2cde23455b30293105cc866c22282d # ratchet:FirebaseExtended/action-hosting-deploy@v0
        if: steps.nek_deploy_needed.outputs.deploy == 1
        with:
          repoToken: '${{ secrets.GITHUB_TOKEN }}'
          firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT_NEW_ENGLAND_KEESHONDS }}'
          channelId: live
          projectId: new-england-keeshonds
          entryPoint: apps/new-england-keeshonds
        # PORTFOLIO
      - name: Check if deploy is needed
        id: portfolio_deploy_needed
        run: echo "::set-output name=deploy::$(./scripts/isequal.sh \"Portfolio\" \"${{ steps.tagname.outputs.tagname }})\""
      - name: Build Portfolio
        run: pnpm exec nx run portfolio:build:production && mv dist/apps/portfolio apps/portfolio/out
        if: steps.portfolio_deploy_needed.outputs.deploy == 1
      - name: Deploy Portfolio
        uses: FirebaseExtended/action-hosting-deploy@276388dd6c2cde23455b30293105cc866c22282d # ratchet:FirebaseExtended/action-hosting-deploy@v0
        if: steps.portfolio_deploy_needed.outputs.deploy == 1
        with:
          repoToken: '${{ secrets.GITHUB_TOKEN }}'
          firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT_PORTFOLIO }}'
          channelId: live
          projectId: personal-portfolio-3ee9b
          entryPoint: apps/portfolio
